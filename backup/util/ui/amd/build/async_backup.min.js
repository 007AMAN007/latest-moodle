define(["jquery","core/ajax","core/str","core/notification","core/templates"],function(a,b,c,d,e){function f(b,c){var d=Math.round(c)+"%",e=a("#"+b+"_bar"),f=c.toFixed(2)+"%";e.attr("aria-valuenow",d),e.css("width",d),e.text(f)}function g(a,b,c){return clearInterval(a),setInterval(b,c)}function h(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[1],j=a(i).text(),k=h[0],l=a(k).text();b.call([{methodname:"core_backup_get_async_backup_links_backup",args:{filename:l,contextid:o}}])[0].done(function(a){var b={filename:l,time:j,size:a.filesize,fileurl:a.fileurl,restoreurl:a.restoreurl};e.render("core/async_backup_progress_row",b).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function i(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[0],j=h[1],k=a(j).text();b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:c,contextid:o}}])[0].done(function(b){var c=a(i).text(),f={resourcename:c,restoreurl:b.restoreurl,time:k};e.render("core/async_restore_progress_row",f).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function j(e){var g,h=100*e.progress,i=a("#"+n+"_bar"),j=a("#"+n+"_status"),k=a("#"+n+"_detail"),l=a("#"+n+"_button");if(e.status==t){i.addClass("bg-success"),f(n,h);var m="async"+q+"processing";c.get_string(m,"backup").then(function(a){return j.text(a),a})["catch"](function(){d.exception(new Error("Failed to load string: backup "+m))})}else if(e.status==u){i.addClass("bg-danger"),i.removeClass("bg-success"),f(n,100);var s="async"+q+"error",w="async"+q+"errordetail";g=[{key:s,component:"backup"},{key:w,component:"backup"}],c.get_strings(g).then(function(a){return j.text(a[0]),k.text(a[1]),a})["catch"](function(){d.exception(new Error("Failed to load string"))}),a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(r)}else if(e.status==v){i.addClass("bg-success"),f(n,100);var x="async"+q+"complete";if(c.get_string(x,"backup").then(function(a){return j.text(a),a})["catch"](function(){d.exception(new Error("Failed to load string: backup "+x))}),"restore"==q)b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:n,contextid:o}}])[0].done(function(a){var b="async"+q+"completedetail",e="async"+q+"completebutton",f=[{key:b,component:"backup",param:a.restoreurl},{key:e,component:"backup"}];c.get_strings(f).then(function(b){return k.html(b[0]),l.text(b[1]),l.attr("href",a.restoreurl),b})["catch"](function(){d.exception(new Error("Failed to load string"))})});else{var y="async"+q+"completedetail",z="async"+q+"completebutton";g=[{key:y,component:"backup",param:p},{key:z,component:"backup"}],c.get_strings(g).then(function(a){return k.html(a[0]),l.text(a[1]),l.attr("href",p),a})["catch"](function(){d.exception(new Error("Failed to load string"))})}a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(r)}}function k(b){b.forEach(function(b){var c=100*b.progress,d=b.backupid,e=a("#"+d+"_bar"),g=b.operation;b.status==t?(e.addClass("bg-success"),f(d,c)):b.status==u?(e.addClass("bg-danger"),e.addClass("complete"),a("#"+d+"_bar").removeClass("bg-success"),f(d,100)):b.status==v&&(e.addClass("bg-success"),e.addClass("complete"),f(d,100),"backup"==g?h(d):i(d))})}function l(){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:[n],contextid:o}}],!0,!0,!1,A)[0].done(function(a){j(a[0]),y=x,r=g(r,l,x)}).fail(function(){y*=z,r=g(r,l,y)})}function m(){var c=[],d=a(".progress").find(".progress-bar").not(".complete");d.each(function(){c.push(this.id.substring(0,32))}),c.length>0?b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:c,contextid:o}}],!0,!0,!1,A)[0].done(function(a){k(a),y=x,s=g(s,m,x)}).fail(function(){y*=z,s=g(s,m,y)}):clearInterval(s)}var n,o,p,q,r,s,t=800,u=900,v=1e3,w={},x=15e3,y=15e3,z=1.5,A=2e3;return w.asyncBackupAllStatus=function(a){o=a,s=setInterval(m,y)},w.asyncBackupStatus=function(b,c,d,e){n=b,o=c,p=d,q="backup"==e?"backup":"restore",a(".backup_progress").children("a").removeAttr("href"),r=setInterval(l,y)},w});