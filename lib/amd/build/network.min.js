define(["jquery","core/ajax","core/config","core/notification","core/str"],function(a,b,c,d,e){var f=!1,g=!1,h=0,i=0,j=!1,k=c.sessiontimeout/10*1e3,l=2*k,m=function(){var a={methodname:"core_session_touch",args:{}};return b.call([a],!0,!0,!1,i)[0].then(function(){return h>0&&setTimeout(m,h),!0}).fail(function(){d.alert("",j)})},n=function(){var a={methodname:"core_session_time_remaining",args:{}};return b.call([a],!0,!0,!0)[0].then(function(a){return!(a.userid<=0)&&(a.timeremaining<0?e.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"}]).then(function(a){return d.alert(a[0],a[1]),!0}).fail(d.exception):1e3*a.timeremaining<l&&!g?(g=!0,e.get_strings([{key:"norecentactivity",component:"moodle"},{key:"sessiontimeoutsoon",component:"moodle"},{key:"extendsession",component:"moodle"},{key:"cancel",component:"moodle"}]).then(function(a){return d.confirm(a[0],a[1],a[2],a[3],function(){return m(),g=!1,setTimeout(n,5*k),!0},function(){g=!1,setTimeout(n,k)}),!0}).fail(d.exception)):setTimeout(n,k),!0)})},o=function(){h>0?setTimeout(m,h):setTimeout(n,5*k)},p=function(){f||(f=!0,o())},q=function(a,b,c){f||(f=!0,h=1e3*a,j=c,i=1e3*b,o())};return{keepalive:q,init:p}});